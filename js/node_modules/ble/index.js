import Promise from 'bluebird';
import BleManager from 'react-native-ble-manager';
import './bleStatusManager';
import v2 from './v2/PeskController';

let peskController;

BleManager.start({ showAlert: false });
BleManager.checkState();

function getPeskController() {
  if (peskController) {
    return peskController;
  }

  peskController = new v2();

  return peskController;
}

function connect(deviceData) {
  getPeskController();
  return peskController.connect({
    connId: deviceData.ssid, // connId would be device SSID
    serviceId: deviceData.connId, // device.connId = serviceId
  });
}

function reset() {
  console.log('[ble] reset');
  if (!peskController) {
    return Promise.resolve();
  }
  return Promise.attempt(() => peskController.reset())
    .delay(1000)
    .then(() => {
      // return peskController.reset().then(() => {
      peskController = null;
    });
}

export default {
  connect,
  reset,
  peskController,
};
